#!/usr/bin/env bash

# Supex CLI wrapper for convenient access from project root
# Logs stdout to supex-cli-stdout.log
# Logs stderr to supex-cli-stderr.log

set -e

# Resolve symlinks to find real script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
  SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
  SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
  # Handle relative symlinks
  [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SUPEX_ROOT="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
# Fallback to ~/.supex/tmp-workspace for ad-hoc CLI usage (not pwd to avoid pollution)
export SUPEX_WORKSPACE="${SUPEX_WORKSPACE:-$HOME/.supex/tmp-workspace}"

LOG_DIR="${SUPEX_LOG_DIR:-$SUPEX_WORKSPACE/.tmp/logs}"
mkdir -p "$LOG_DIR"

STDOUT_LOG="$LOG_DIR/supex-cli-stdout.log"
STDERR_LOG="$LOG_DIR/supex-cli-stderr.log"

# Preserve TTY detection for rich formatting (tee breaks isatty())
if [ -t 1 ]; then
  export FORCE_COLOR=1
fi

# Run supex CLI with logging
# Use process substitution to tee stderr (show in terminal AND log to file)
uv run --project "$SUPEX_ROOT/driver" supex "$@" 2> >(tee -a "$STDERR_LOG" >&2) | \
  tee -a "$STDOUT_LOG"
